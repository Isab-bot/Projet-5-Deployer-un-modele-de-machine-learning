name: CI - Tests automatiques

# Quand déclencher le workflow
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Les jobs à exécuter
jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Récupérer le code
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        lfs: true 
    
    # 2. Installer Python
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    
    # 3. Installer UV
    - name: Install UV
      run: |
        pip install uv
    
    # 4. Installer les dépendances avec UV
    - name: Install dependencies
      run: |
        uv sync
    
    # 5. Vérifier que le modèle existe
    - name: Check model file
      run: |
        ls -lh models/xgboost_pipeline.joblib
    
    # 6. Lancer les tests
    - name: Run tests with pytest
      env:
        API_KEY: test-api-key-for-ci
        DATABASE_URL: sqlite:///./test_hr_analytics.db
      run: |
        uv run pytest tests/ -v --tb=short